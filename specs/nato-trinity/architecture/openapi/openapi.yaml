openapi: 3.0.3
info:
  title: NATO Trinity API
  version: 0.2.0
servers:
  - url: https://example.local
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Problem:
      type: object
      required: [type, title, status]
      properties:
        type: { type: string, example: "about:blank" }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string }
        requestId: { type: string }
        errorCode: { type: string }
    GateResult:
      type: object
      required: [gateResultId, gateId, targetRef, status, executedAt]
      properties:
        gateResultId: { type: string }
        gateId: { type: string }
        targetRef: { type: string }
        status: { type: string, enum: [pass, fail, warn] }
        executedAt: { type: string, format: date-time }
        evidenceRefs: { type: array, items: { type: string } }
        caseRef: { type: string }
    Evidence:
      type: object
      required: [evidenceId, evidenceType, sourceSystem, collectedAt, hash, storageRef]
      properties:
        evidenceId: { type: string }
        evidenceType: { type: string }
        sourceSystem: { type: string }
        collectedAt: { type: string, format: date-time }
        hash: { type: string }
        storageRef: { type: string }
        classification: { type: string, enum: [public, internal, sensitive] }
        retentionClass: { type: string, enum: [short, standard, long, legal] }
    Risk:
      type: object
      required: [riskId, title, owner, likelihood, impact, score, status, dueDate]
      properties:
        riskId: { type: string }
        title: { type: string }
        owner: { type: string }
        likelihood: { type: integer, minimum: 1, maximum: 5 }
        impact: { type: integer, minimum: 1, maximum: 5 }
        score: { type: integer, minimum: 1, maximum: 25 }
        status: { type: string }
        dueDate: { type: string, format: date }
        controlRefs: { type: array, items: { type: string } }
        evidenceRefs: { type: array, items: { type: string } }
    Decision:
      type: object
      required: [decisionId, riskId, decisionType, rationale, approvedBy, approvedAt]
      properties:
        decisionId: { type: string }
        riskId: { type: string }
        decisionType: { type: string, enum: [treat, avoid, transfer, accept] }
        rationale: { type: string }
        approvedBy: { type: string }
        approvedAt: { type: string, format: date-time }
        expiryDate: { type: string, format: date }
    Exception:
      type: object
      required: [exceptionId, requirementRef, scope, rationale, approvedBy, approvedAt, expiryDate]
      properties:
        exceptionId: { type: string }
        requirementRef: { type: string }
        scope: { type: string }
        rationale: { type: string }
        approvedBy: { type: string }
        approvedAt: { type: string, format: date-time }
        expiryDate: { type: string, format: date }
    EvidencePackage:
      type: object
      required: [packageId, scopeRef, evidenceRefs, manifestHash, exportedAt, exportedBy]
      properties:
        packageId: { type: string }
        scopeRef: { type: string }
        evidenceRefs: { type: array, items: { type: string } }
        manifestHash: { type: string }
        exportedAt: { type: string, format: date-time }
        exportedBy: { type: string }
        bundleRef: { type: string }
    LegalHold:
      type: object
      required: [holdId, orgId, scopeRef, reason, status]
      properties:
        holdId: { type: string }
        orgId: { type: string }
        scopeRef: { type: string }
        reason: { type: string }
        status: { type: string, enum: [active, released] }
    AuditEvent:
      type: object
      required: [eventId, orgId, actor, action, objectRef, timestamp, outcome]
      properties:
        eventId: { type: string }
        orgId: { type: string }
        actor: { type: string }
        action: { type: string }
        objectRef: { type: string }
        timestamp: { type: string, format: date-time }
        outcome: { type: string, enum: [success, failure] }

    Case:
      type: object
      required: [caseId, riskId, severity, status, owner]
      properties:
        caseId: { type: string }
        riskId: { type: string }
        severity: { type: string, enum: [low, medium, high, critical] }
        status: { type: string, enum: [triage, in_progress, resolved, closed] }
        owner: { type: string }
        createdAt: { type: string, format: date-time }
        createdBy: { type: string }
        updatedAt: { type: string, format: date-time }
        updatedBy: { type: string }

    ChainOfCustodyEvent:
      type: object
      required: [eventId, evidenceId, action, timestamp, actor]
      properties:
        eventId: { type: string }
        evidenceId: { type: string }
        action: { type: string, enum: [collected, transferred, accessed, sealed, verified] }
        timestamp: { type: string, format: date-time }
        actor: { type: string }
        location: { type: string }
        details: { type: string }

    Gate:
      type: object
      required: [gateId, name, status]
      properties:
        gateId: { type: string }
        name: { type: string }
        description: { type: string }
        status: { type: string, enum: [active, disabled] }
        policyRef: { type: string }

    Manifest:
      type: object
      required: [manifestVersion, packageId, generatedAt, generatedBy, hashAlg, items]
      properties:
        manifestVersion: { type: string }
        packageId: { type: string }
        generatedAt: { type: string, format: date-time }
        generatedBy: { type: string }
        hashAlg: { type: string, enum: [sha256] }
        items:
          type: array
          items:
            type: object
            required: [evidenceId, hash, storageRef]
            properties:
              evidenceId: { type: string }
              hash: { type: string }
              storageRef: { type: string }
              evidenceType: { type: string }
              sourceSystem: { type: string }
              collectedAt: { type: string, format: date-time }
        signature:
          type: object
          properties:
            keyId: { type: string }
            alg: { type: string }
            value: { type: string }

    Playbook:
      type: object
      required: [playbookId, name, version]
      properties:
        playbookId: { type: string }
        name: { type: string }
        version: { type: integer, minimum: 1 }
        description: { type: string }
        trigger: { type: string }
        steps:
          type: array
          items:
            type: object
            properties:
              stepId: { type: string }
              action: { type: string }
              params: { type: object, additionalProperties: true }

    ExecutionTrace:
      type: object
      required: [traceId, status, startedAt]
      properties:
        traceId: { type: string }
        status: { type: string, enum: [running, success, failure] }
        startedAt: { type: string, format: date-time }
        endedAt: { type: string, format: date-time }
        requestId: { type: string }
        steps:
          type: array
          items:
            type: object
            properties:
              stepId: { type: string }
              status: { type: string }
              startedAt: { type: string, format: date-time }
              endedAt: { type: string, format: date-time }
              logsRef: { type: string }

security:
  - bearerAuth: []
paths:
  /api/v1/risks:
    get:
      summary: List risks
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Risk'
    post:
      summary: Create risk
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Risk'
      responses:
        '201':
          description: Created
  /api/v1/risks/{riskId}/decisions:
    post:
      summary: Create decision for a risk
      parameters:
        - name: riskId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Decision'
      responses:
        '201':
          description: Created
  /api/v1/exceptions:
    post:
      summary: Create exception
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Exception'
      responses:
        '201':
          description: Created
  /api/v1/gates/{gateId}/run:
    post:
      summary: Run a gate and produce GateResult
      parameters:
        - name: gateId
          in: path
          required: true
          schema:
            type: string
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GateResult'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/gate-results/{gateResultId}:
    get:
      summary: Get GateResult
      parameters:
        - name: gateResultId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GateResult'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/evidence:
    get:
      summary: List evidence
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
        - name: after
          in: query
          schema: { type: string }
        - name: evidenceType
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Evidence'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    post:
      summary: Ingest evidence (collector)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Evidence'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Evidence'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/evidence/{evidenceId}:
    get:
      summary: Get evidence
      parameters:
        - name: evidenceId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Evidence'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/evidence/{evidenceId}/purge:
    post:
      summary: Purge evidence (controlled)
      description: Baseline requires Approver; regulated requires two-person + WORM constraints (ADR-0011).
      parameters:
        - name: evidenceId
          in: path
          required: true
          schema: { type: string }
      responses:
        '202':
          description: Accepted
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/evidence-packages:
    post:
      summary: Export an EvidencePackage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [scopeRef]
              properties:
                scopeRef: { type: string }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidencePackage'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '403':
          description: Forbidden
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    get:
      summary: List evidence packages
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
        - name: after
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EvidencePackage'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/evidence-packages/{packageId}:
    get:
      summary: Get evidence package
      parameters:
        - name: packageId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidencePackage'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/legal-holds/{holdId}:
    get:
      summary: Get legal hold
      parameters:
        - name: holdId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHold'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
  /api/v1/legal-holds:
    get:
      summary: List legal holds
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
        - name: after
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LegalHold'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    post:
      summary: Create legal hold
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LegalHold'
      responses:
        '201':
          description: Created
    patch:
      summary: Release legal hold
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [holdId, status]
              properties:
                holdId: { type: string }
                status: { type: string, enum: [released] }
      responses:
        '200':
          description: OK
  /api/v1/audit-events:
    get:
      summary: List audit events
      parameters:
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 500, default: 100 }
        - name: after
          in: query
          schema: { type: string }
        - name: actor
          in: query
          schema: { type: string }
        - name: action
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditEvent'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '403':
          description: Forbidden
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
